- name: MAEL.IA ‚Äî Franck Bot
  group: mael
  description: "Ex√©cute app.py pour Franck (bot principal) depuis GitHub"
  loglevel: INFO
  executionEnabled: true
  nodeFilterEditable: false
  sequence:
    keepgoing: false
    strategy: node-first
    commands:
      - scriptInterpreter: /bin/bash
        interpreterArgsQuoted: false
        fileExtension: .sh
        script: |
          set -eu

          # ü§ñ Configuration Franck
          BOT_NAME="Franck"
          BOT_DIR="MAEL.IA"
          PID_FILE="${BOT_DIR}/.franck.pid"

          echo "‚û°Ô∏è Clone/Pull ($BOT_NAME)"
          if [ ! -d "${BOT_DIR}/.git" ]; then
            git clone "${RD_OPTION_GIT_URL}" "${BOT_DIR}"
          fi
          cd "${BOT_DIR}"

          # üìå Branche pour Franck
          BRANCH="${RD_OPTION_GIT_BRANCH}"
          git fetch --all --prune || true
          git checkout "$BRANCH" || git checkout -b "$BRANCH" "origin/$BRANCH"
          git pull --ff-only || true

          echo "‚û°Ô∏è venv + deps"
          if command -v python3 >/dev/null 2>&1; then PY=python3; else PY=python; fi
          if [ ! -d ".venv" ]; then $PY -m venv .venv || true; fi
          . .venv/bin/activate
          $PY -m pip install --upgrade pip
          awk '!/^mcp(\[.*\])?(\s*==.*)?$/ && !/^\s*#/ && NF' requirements.txt > .req_nop.txt
          pip install -r .req_nop.txt

          echo "‚û°Ô∏è service_account.json (depuis base64)"
          printf "%s" "${RD_OPTION_SERVICE_ACCOUNT_B64}" | base64 -d > service_account.json
          chmod 600 service_account.json
          $PY - <<'PY'
import json,sys,pathlib
p=pathlib.Path("service_account.json")
t=p.read_text(errors="replace")
try:
    j=json.loads(t)
    print("JSON OK: project_id=", j.get("project_id"))
except Exception as e:
    print("INVALID JSON:", e); sys.exit(2)
PY
          export GOOGLE_APPLICATION_CREDENTIALS="$(pwd)/service_account.json"

          echo "‚û°Ô∏è G√©n√©ration du .env pour $BOT_NAME"
          umask 177
          : > .env
          {
            echo "BOT_NAME=${BOT_NAME}"
            echo "BQ_PROJECT=${RD_OPTION_BQ_PROJECT}"
            echo "BQ_LOCATION=${RD_OPTION_BQ_LOCATION}"
            echo "BQ_ALLOWED_DATASETS=${RD_OPTION_BQ_ALLOWED_DATASETS}"
            echo "OPENAI_API_KEY=${RD_OPTION_OPENAI_API_KEY}"
            echo "ANTHROPIC_API_KEY=${RD_OPTION_ANTHROPIC_API_KEY}"
            echo "SLACK_APP_TOKEN=${RD_OPTION_SLACK_APP_TOKEN}"
            echo "SLACK_BOT_TOKEN=${RD_OPTION_SLACK_BOT_TOKEN}"
            echo "DBT_MANIFEST_PATH=${RD_OPTION_DBT_MANIFEST_PATH:-/home/rundeck/DBT/target/manifest.json}"
            echo "DBT_SCHEMAS=${RD_OPTION_DBT_SCHEMAS:-sales,user,inter,crm,ops,reviews}"
            echo "NOTION_API_KEY=${RD_OPTION_NOTION_API_KEY}"
            echo "NOTION_TEST_PAGE_ID=${RD_OPTION_NOTION_TEST_PAGE_ID}"
            echo "NOTION_STORAGE_PAGE_ID=${RD_OPTION_NOTION_STORAGE_PAGE_ID}"
            echo "NOTION_CONTEXT_PAGE_ID=${RD_OPTION_NOTION_CONTEXT_PAGE_ID}"
            echo "BIGQUERY_PROJECT_ID=${RD_OPTION_BQ_PROJECT}"
            echo "BIGQUERY_PROJECT_ID_2=${RD_OPTION_BIGQUERY_PROJECT_ID_2:-normalised-417010}"
            echo "GOOGLE_APPLICATION_CREDENTIALS=$(pwd)/service_account.json"

            # üÜï MORNING SUMMARY pour Franck
            echo "MORNING_SUMMARY_ENABLED=${RD_OPTION_MORNING_SUMMARY_ENABLED:-true}"
            echo "MORNING_SUMMARY_HOUR=${RD_OPTION_MORNING_SUMMARY_HOUR:-8}"
            echo "MORNING_SUMMARY_MINUTE=${RD_OPTION_MORNING_SUMMARY_MINUTE:-30}"
            echo "MORNING_SUMMARY_CHANNEL=${RD_OPTION_MORNING_SUMMARY_CHANNEL:-team_data}"

            # üÜï ANALYSES PROACTIVES
            echo "PROACTIVE_ANALYSIS=${RD_OPTION_PROACTIVE_ANALYSIS:-true}"
            echo "AUTO_COMPARE=${RD_OPTION_AUTO_COMPARE:-true}"
            echo "MAX_DRILL_DOWNS=${RD_OPTION_MAX_DRILL_DOWNS:-3}"

            # üîß FIX PROXY : Bypasser le proxy pour les API externes
            echo "NO_PROXY=localhost,127.0.0.1,169.254.169.254,metadata.google.internal,*.googleapis.com,*.google.com,api.anthropic.com,slack.com,*.slack.com,notion.so,*.notion.so"
          } >> .env

          echo "=== DEBUG: Contenu du .env pour $BOT_NAME ==="
          cat .env
          echo "=============================="

          echo "‚û°Ô∏è Nettoyage de l'ancienne instance de $BOT_NAME uniquement"
          if [ -f "$PID_FILE" ]; then
            OLD_PID=$(cat "$PID_FILE")
            if ps -p "$OLD_PID" > /dev/null 2>&1; then
              echo "Arr√™t de l'ancienne instance (PID: $OLD_PID)"
              kill -9 "$OLD_PID" || true
            fi
            rm -f "$PID_FILE"
          fi
          sleep 2

          echo "‚û°Ô∏è Lancement de $BOT_NAME"
          python app.py &
          NEW_PID=$!
          echo "$NEW_PID" > "$PID_FILE"
          echo "‚úÖ $BOT_NAME d√©marr√© avec PID: $NEW_PID"

          # Attendre pour garder le job actif
          wait $NEW_PID
  options:
    - name: git_url
      defaultValue: "https://github.com/matblissim/MAEL.IA"
      required: true
    - name: git_branch
      defaultValue: "claude/fix-duplicate-thread-replies-011CUktBeCDj6emvErep39x5"
      required: true
      description: "Branche pour Franck (ex: main, develop, claude/...)"

    - name: BQ_PROJECT
      defaultValue: "teamdata-291012"
      required: true
    - name: BQ_LOCATION
      defaultValue: "europe-west1"
      required: true
    - name: BQ_ALLOWED_DATASETS
      defaultValue: "sales,inter,user,review"
      required: true
    - name: BIGQUERY_PROJECT_ID_2
      defaultValue: "normalised-417010"
      required: false
      description: "Projet BigQuery secondaire (normalised)"

    # GCP Service Account (partag√©e avec FRIDA)
    - name: SERVICE_ACCOUNT_B64
      required: true
      secure: true
      valueExposed: false
      description: "Cl√© GCP service account (base64)"
      storagePath: "keys/service_account_b64"

    # API Keys PARTAG√âES avec FRIDA
    - name: OPENAI_API_KEY
      required: true
      secure: true
      valueExposed: false
      description: "Cl√© OpenAI (partag√©e)"
      storagePath: "keys/OPENAI_API_KEY"

    - name: ANTHROPIC_API_KEY
      required: true
      secure: true
      valueExposed: false
      description: "Cl√© Anthropic (partag√©e)"
      storagePath: "keys/ANTHROPIC_API_KEY"

    # Slack Keys SP√âCIFIQUES √† Franck
    - name: SLACK_APP_TOKEN
      required: true
      secure: true
      valueExposed: false
      description: "Cl√© Slack App Franck (xapp-...)"
      storagePath: "keys/SLACK_APP_TOKEN"

    - name: SLACK_BOT_TOKEN
      required: true
      secure: true
      valueExposed: false
      description: "Cl√© Slack Bot Franck (xoxb-...)"
      storagePath: "keys/SLACK_BOT_TOKEN"

    # DBT Configuration
    - name: DBT_MANIFEST_PATH
      defaultValue: "/home/rundeck/DBT/target/manifest.json"
      required: false
      description: "Chemin vers le manifest DBT"

    - name: DBT_SCHEMAS
      defaultValue: "sales,user,inter,crm,ops,reviews"
      required: false
      description: "Sch√©mas DBT autoris√©s"

    # Notion (optionnelles, partag√©es avec FRIDA)
    - name: NOTION_API_KEY
      required: false
      secure: true
      valueExposed: false
      description: "Cl√© Notion (partag√©e)"
      storagePath: "keys/NOTION_API_KEY"

    - name: NOTION_TEST_PAGE_ID
      required: false
      secure: true
      valueExposed: false
      storagePath: "keys/NOTION_TEST_PAGE_ID"

    - name: NOTION_STORAGE_PAGE_ID
      required: false
      secure: true
      valueExposed: false
      storagePath: "keys/NOTION_STORAGE_PAGE_ID"

    - name: NOTION_CONTEXT_PAGE_ID
      required: false
      secure: true
      valueExposed: false
      storagePath: "keys/NOTION_CONTEXT_PAGE_ID"

    # Morning Summary Configuration
    - name: MORNING_SUMMARY_ENABLED
      defaultValue: "true"
      required: false
      description: "Activer le bilan matinal (true/false)"

    - name: MORNING_SUMMARY_HOUR
      defaultValue: "8"
      required: false
      description: "Heure du bilan matinal (0-23)"

    - name: MORNING_SUMMARY_MINUTE
      defaultValue: "30"
      required: false
      description: "Minute du bilan matinal (0-59)"

    - name: MORNING_SUMMARY_CHANNEL
      defaultValue: "team_data"
      required: false
      description: "Canal Slack pour le bilan matinal"

    # Proactive Analysis Configuration
    - name: PROACTIVE_ANALYSIS
      defaultValue: "true"
      required: false
      description: "Activer l'analyse proactive (true/false)"

    - name: AUTO_COMPARE
      defaultValue: "true"
      required: false
      description: "Activer les comparaisons automatiques (true/false)"

    - name: MAX_DRILL_DOWNS
      defaultValue: "3"
      required: false
      description: "Nombre maximum de drill-downs"
